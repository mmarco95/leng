<html>

<head>
    <meta charset="UTF-8">
    <title>IPRASE</title>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="bulma.css">
    <link rel="stylesheet" type="text/css" href="css.css">

</head>
<script src="https://cdnjs.com/libraries/Chart.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<body>
    <div id="corpo">
        <nav class="navbar" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <div class="navbar-item">
                    <img src="logo.png" width="112" height="30">

                </div>
                <div class="navbar-item content has-text-centered" id="testo">
                    TRENTINO LANGUAGE TESTING
                </div>

            </div>
        </nav>
        <div class="container">
            <div class="tile is-ancestor">
                <div class="tile is-parent">
                    <article class="tile is-child box">
                        <p class="title">Lingua</p>
                        <input type="checkbox" name="ted" id="ted" checked>
                        <label for="ted">
                            Tedesco
                        </label>
                        <br>
                        <input type="checkbox" name="ing" id="ing">
                        <label for="ing">
                            Inglese
                        </label>
                    </article>
                </div>

                <div class="tile is-parent">
                    <article class="tile is-child box">
                        <p class="title">Anno</p>
                        <input type="checkbox" name="2016" checked> 2016
                        <br>
                        <input type="checkbox" name="2016" checked> 2017
                        <br>
                        <label class="checkbox" disabled>
                            <input type="checkbox" disabled name="2018"> 2018
                        </label>


                    </article>
                </div>

                <div class="tile is-parent">
                    <article class="tile is-child box">
                        <p class="title">Livello</p>
                        <input type="radio" name="livello" id="A1" onchange="modificaDomanda()"> A1
                        <br>
                        <input type="radio" name="livello" id="A2" onchange="modificaDomanda()"> A2
                        <br>
                        <input type="radio" name="livello" id="B1" onchange="modificaDomanda()"> B1
                    </article>
                </div>

                <div class="tile is-parent">
                    <article class="tile is-child box">
                        <p class="title">Prova</p>
                        <label class="checkbox" disabled>
                            <input type="checkbox" disabled name="let"> Lettura
                        </label>
                        <br>
                        <input type="checkbox" name="scr"> Scrittura
                        <br>
                        <label class="checkbox" disabled>
                            <input type="checkbox" disabled name="par"> Parlato
                            <br>
                            <input type="checkbox" disabled name="asc"> Ascolto
                            <br>
                            <input type="checkbox" disabled name="com"> Competenze formali
                        </label>
                    </article>
                </div>

                <div class="tile is-parent">
                    <article class="tile is-child box">
                        <p class="title">Tipo domanda</p>
                        <label class="checkbox" disabled>
                            <input type="checkbox"> P1
                            <br>
                            <input type="checkbox"> P2
                        </label>
                        <br>
                        <input type="checkbox" name="S1" id="S1" checked> S1
                        <br>
                        <input type="checkbox" name="S2" id="S2" checked> S2
                    </article>
                </div>

                <div class="tile is-parent">
                    <article class="tile is-child box">
                        <p class="title">Indicatore</p>
                        <input type="checkbox" name="let" value="lessico" id="LESSICO" checked> Lessico
                        <br>
                        <input type="checkbox" name="scr" id="CORRETTEZZA" checked> Correttezza competenze formali
                        <br>
                        <input type="checkbox" name="par" id="ADEMPIMENTO"> Adempimento alla consegna
                        <br>
                        <input type="checkbox" name="asc" id="COERENZA"> Coerenza e coesione
                        <br>
                        <input type="checkbox" name="com" id="CAPACITA"> Capacità comunicative e descrittive
                        <br>
                        <input type="checkbox" name="com" id="OPINIONI"> Capacità esprimere proprie opinioni
                        <br>
                        <input type="checkbox" name="com" id="SENTIMENTI"> Capacità esprimere i propri sentimenti

                    </article>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="content has-text-centered">
                <a class="button is-rounded" id="confronta" onclick="confronta()">Confronta</a>
                <a class="button is-rounded" id="confronta" onclick="visualizza()">Visualizza</a>
            </div>
        </div>

        <div id="graphs">

        </div>
    </div>
</body>

<script type="text/javascript" src="chart.js"></script>
<script>



    let dati = [];


    fetch('provascrit.json')
        .then(resp => resp.json())
        .then(d => {
            dati = d;
        })


    function visualizza() {
        let divGrafici = document.getElementById("graphs");
        divGrafici.innerHTML = '';

        let lingua = $("#ted").is(":checked") ? "DE" : "ENG"
        console.log(lingua)
        let anno = $("#ted").is(":checked") ? "tedesco" : "inglese"

        filteredData = dati.filter(d => d.LEN == lingua)



        console.log("dati filtrati per anno: ", filteredData)

        let levels = [];

        ["A1", "A2", "B1"].map((level) => {
            if ($(`#${level}`).is(":checked"))
                levels.push(level)
        });

        console.log(levels)

        filteredData = filteredData.filter(d => levels.includes(d.LIVELLO))

        console.log("dati filtrati per livello: ", filteredData)



        let types = [];

        ["S1", "S2"].map((type) => {
            if ($(`#${type}`).is(":checked"))
                types.push(type)
        });

        console.log(types)

        filteredData = filteredData.filter(d => types.includes(d.DOMANDA))

        console.log("dati filtrati per tipo di domanda: ", filteredData)
        console.log("--------------------------------")

        let inds = [];

        ["LESSICO", "CORRETTEZZA", "ADEMPIMENTO", "COERENZA", "CAPACITA", "OPINIONI", "SENTIMENTI"].map((ind) => {
            if ($(`#${ind}`).is(":checked"))
                inds.push(ind)
        });

        console.log(inds)

        filteredData = filteredData.filter(d => inds.includes(d.INDICATORE))

        console.log("dati filtrati per indicatore: ", filteredData)


        filteredData.map(row => {
            console.log("row", row)
            let ctx = document.createElement("canvas")
            let title = document.createElement("h1")
            title.className = "titoletto"
            title.textContent = `${row.ANNO} - ${row.LEN} - ${row.LIVELLO} - ${row.DOMANDA} - ${row.INDICATORE}`;
            let container = document.createElement("div")

            container.appendChild(title)
            container.appendChild(ctx)
            container.className = "grafico"

            divGrafici.appendChild(container)

            createGraph(ctx, row.LABEL, row.DATA);
        })

        console.log("--------------------------------")

    }


    function confronta() {
        let divGrafici = document.getElementById("graphs");
        divGrafici.innerHTML = '';

        let lingua = $("#ted").is(":checked") ? "DE" : "ENG"
        //console.log(lingua)
        // let anno = $("#ted").is(":checked") ? "tedesco" : "inglese"

        filteredData = dati.filter(d => d.LEN == lingua)



        //console.log("dati filtrati per anno: ", filteredData)

        let levels = [];

        ["A1", "A2", "B1"].map((level) => {
            if ($(`#${level}`).is(":checked"))
                levels.push(level)
        });

        //console.log(levels)

        filteredData = filteredData.filter(d => levels.includes(d.LIVELLO))

        //console.log("dati filtrati per livello: ", filteredData)



        let types = [];

        ["S1", "S2"].map((type) => {
            if ($(`#${type}`).is(":checked"))
                types.push(type)
        });

        //console.log(types)

        filteredData = filteredData.filter(d => types.includes(d.DOMANDA))

        //console.log("dati filtrati per tipo di domanda: ", filteredData)
        //console.log("--------------------------------")

        let inds = [];

        ["LESSICO", "CORRETTEZZA", "ADEMPIMENTO", "COERENZA", "CAPACITA", "OPINIONI", "SENTIMENTI"].map((ind) => {
            if ($(`#${ind}`).is(":checked"))
                inds.push(ind)
        });

        // console.log(inds)

        filteredData = filteredData.filter(d => inds.includes(d.INDICATORE))

        console.log("dati filtrati per indicatore: ")
        filteredData.map(data => console.log(data))


        let comparati = [];
        while (filteredData.length > 0) {
            let first = filteredData.shift()
            console.log(">-----------")
            console.log("first", first)

            let i = 0;
            while (i < filteredData.length &&
                (
                    filteredData[i].DOMANDA != first.DOMANDA ||
                    filteredData[i].LIVELLO != first.LIVELLO ||
                    filteredData[i].PROVA != first.PROVA ||
                    filteredData[i].INDICATORE != first.INDICATORE
                )
            ) {
                i++
            }

            let second = filteredData[i];
            filteredData.splice(i, 1);
            console.log("trovato altro dato: ", second)


            if (second) {

                comparati.push({
                    LABEL: first.LABEL,
                    data1: first.DATA,
                    data2: second.DATA,
                    LEN: first.LEN,
                    LIVELLO: first.LIVELLO,
                    DOMANDA: first.DOMANDA,
                    INDICATORE: first.INDICATORE
                })

            }
        }

        comparati.map(row => {
            console.log("row", row)
            let ctx = document.createElement("canvas")
            let title = document.createElement("h1")
            title.className = "titoletto"
            title.textContent = `${row.LEN} - ${row.LIVELLO} - ${row.DOMANDA} - ${row.INDICATORE}`;
            let container = document.createElement("div")

            container.appendChild(title)
            container.appendChild(ctx)
            container.className = "grafico"

            divGrafici.appendChild(container)

            createGraph2(ctx, row.LABEL, row.data1, row.data2);
        })

        console.log("--------------------------------")

    }




    function createGraph(ctx, labels, data) {

        let campo = "frequency"

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '# of Votes',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 0, 0, 0.8)',
                        'rgba(255, 128, 0, 0.8)',
                        'rgba(0, 179, 60, 0.8)'

                    ],
                    borderColor: [
                        'rgba(255, 0, 0, 1)',
                        'rgba(255, 128, 0, 1)',
                        'rgba(0, 179, 60, 0.8)'

                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },

                legend: {
                    display: false
                },
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem) {
                            return tooltipItem.yLabel;
                        }
                    }
                }
            }

        });

        myChart.canvas.parentNode.style.height = '900px';
        myChart.canvas.parentNode.style.width = '900px';
        return ctx;
    }


    function createGraph2(ctx, labels, data1, data2) {



        var myChart2 = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["0", "1", "2"],
                datasets: [
                    {
                        label: "2016",
                        backgroundColor: "#66a3ff",
                        data: data1
                    }, {
                        label: "2017",
                        backgroundColor: "#ff9933",
                        data: data2
                    }
                ]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },

                legend: {
                    display: true
                },
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem) {
                            return tooltipItem.yLabel;
                        }
                    }
                }
            }


        });

    }

    //().ready(confronta)

    function modificaDomanda() {
        set("S1", !document.getElementById("A1").checked)
    }

    function set(id, abilitato) {
        let element = document.getElementById(id)
        if (abilitato) {
            element.disabled = false;
        }
        else {
            element.disabled = true;
            element.checked = false;
        }
    }

</script>

</html>