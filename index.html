<html>

<head>
    <meta charset="UTF-8">
    <title>IPRASE</title>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="bulma.css">
    <link rel="stylesheet" type="text/css" href="css.css">

</head>
<script src="https://cdnjs.com/libraries/Chart.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<body>
    <div id="corpo">
        <nav class="navbar" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <div class="navbar-item">
                    <img src="logo.png" width="112" height="30">

                </div>
                <div class="navbar-item content has-text-centered" id="testo">
                    TRENTINO LANGUAGE TESTING
                </div>

            </div>
        </nav>
        <div id="sinistra">

            <div class="container">
                <div class="tile is-ancestor">
                    <div class="tile is-parent is-vertical">
                        <article class="tile is-child">
                            <p class="title">Lingua</p>
                            <input type="checkbox" name="ted" id="DE">
                            <label for="DE">
                                Tedesco
                            </label>
                            <br>
                            <input type="checkbox" name="ing" id="ENG">
                            <label for="ENG">
                                Inglese
                            </label>
                        </article>

                        <article class="tile is-child">
                            <p class="title">Anno</p>
                            <input type="checkbox" name="anno" id="2016" onchange="visualizza2016()">
                            <label for="2016">
                                2016
                            </label>
                            <br>
                            <input type="checkbox" name="anno" id="2017" onchange="visualizza2017()">
                            <label for="2017">
                                2017 Tryout
                            </label>
                            <br>

                            <!-- <input type="checkbox" disabled name="2018">
                            <label for="2018" disabled>
                                2018
                            </label> -->

                            <!-- <a class="button is-rounded" id="confronta" onclick="confronta()">Confronta</a> -->
                        </article>
                    </div>

                    <div class="tile is-parent is-vertical">
                        <article class="tile is-child">
                            <p class="title">Livello</p>
                            <input type="radio" name="livello" id="A1" onchange="modificaDomanda()">
                            <label for="A1">
                                A1
                            </label>
                            <br>
                            <input type="radio" name="livello" id="A2" onchange="modificaDomanda()">
                            <label for="A2">
                                A2
                            </label>
                            <br>
                            <input type="radio" name="livello" id="B1" onchange="modificaDomanda()">
                            <label for="B1">
                                B1
                            </label>
                        </article>



                        <article class="tile is-child">
                            <p class="title">Prova</p>
                            <input type="radio" name="prova" id="SCRITTO" onchange="IndicatoriScr()">
                            <label for="SCRITTO">
                                Scrittura
                            </label>
                            <br>
                            <input type="radio" name="prova" id="PARLATO" onchange="IndicatoriPar()">
                            <label for="PARLATO">
                                Parlato
                            </label>

                        </article>
                        <article class="tile is-child">
                            <p class="title">Tipo domanda</p>
                            <div id="parlatobox">
                                <input type="checkbox" id="P1">
                                <label for="P1">
                                    P1
                                </label>
                                <br>
                                <input type="checkbox" id="P2">
                                <label for="P2">
                                    P2
                                </label>
                                <br>
                            </div>
                            <div id="scrittobox">
                                <input type="checkbox" name="S1" id="S1">
                                <label for="S1" id="S1color">
                                    S1
                                </label>
                                <br>
                                <input type="checkbox" name="S2" id="S2" onchange="modificaIndicatore()">
                                <label for="S2">
                                    S2
                                </label>
                            </div>
                        </article>

                    </div>

                    <div class="tile is-parent is-vertical">
                        <article class="tile is-child">
                            <p class="title">Indicatori Scritto</p>
                            <div id="indicatoriScr">
                                <select name="INDICATORE2" id="INDICATORE2">
                                    <option value="LESSICO">Lessico</option>
                                    <option value="CORRETTEZZA">Correttezza competenze formali</option>
                                    <option value="ADEMPIMENTO">Adempimento alla consegna</option>
                                    <option value="COERENZA">Coerenza e Coesione</option>
                                    <option value="CAPACITA">Capacità comunicativa e descrittive</option>
                                    <option value="OPINIONI">Capacità esprimere proprie opinioni</option>
                                    <option value="SENTIMENTI">Capacità esprimere i propri sentimenti</option>
                                    <option value="IMPRESSIONE" class="20172">Impressione generale</option>
                                    <option value="ORTOGRAFIA">Ortografia e punteggiatura</option>
                                </select>
                            </div>
                        </article>

                        <article class="tile is-child">
                            <p class="title">Indicatori Parlato</p>
                            <div id="indicatoriPar">
                                <select name="INDICATORE3" id="INDICATORE3">
                                    <option value="LESSICO">Lessico</option>
                                    <option value="CORRETTEZZA">Correttezza competenze formali</option>
                                    <option value="PRONUNCIA">Pronuncia</option>
                                    <option value="ADEMPIMENTO">Adempimento alla consegna</option>
                                    <option value="TEMPO">Tempo di reazione</option>
                                    <option value="CAPACITA">Capacità comunicativa e descrittive</option>
                                    <option value="OPINIONI">Capacità esprimere proprie opinioni</option>
                                </select>
                            </div>
                        </article>




                        <!-- <article class="tile is-child">
                            <p class="title">Indicatori solo 2017</p>
                            <div id="indicatori2017">
                                <select name="INDICATORE2" id="INDICATORE2">
                                        <option value="IMPRESSIONE">Impressione generale</option>
                                        <option value="ORTOGRAFIA">Ortografia e punteggiatura</option>   
                                    </select>
                            </div>
                        </article> -->
                    </div>
                </div>
            </div>


            <div class="content has-text-centered">
                <a class="button is-rounded" id="confronta" onclick="bivio()">Visualizza</a>
            </div>
        </div>

        <div id="destra">
            <div id="graphs">

            </div>
        </div>
    </div>
</body>

<script type="text/javascript" src="chart.js"></script>
<script>



    let dati = [];


    fetch('provascrit.json')
        .then(resp => resp.json())
        .then(d => {
            dati = d;
        })

    function bivio() {
        if ((document.getElementById("2017").checked) && document.getElementById("2016").checked) {
            confronta();
        }
        else
            visualizza();
    }


    function visualizza() {
        let divGrafici = document.getElementById("graphs");
        divGrafici.innerHTML = '';

        let lingue = [];

        ["DE", "ENG"].map((lingua) => {
            if ($(`#${lingua}`).is(":checked"))
                lingue.push(lingua)
        });

        console.log(lingue)

        filteredData = dati.filter(d => lingue.includes(d.LEN))

        console.log("dati filtrati per lingua: ", filteredData)


        let anni = [];

        [2016, 2017].map((anno) => {
            if ($(`#${anno}`).is(":checked"))
                anni.push(anno)
        });

        console.log(anni)

        filteredData = filteredData.filter(d => anni.includes(d.ANNO))

        console.log("dati filtrati per anno: ", filteredData)







        let levels = [];

        ["A1", "A2", "B1"].map((level) => {
            if ($(`#${level}`).is(":checked"))
                levels.push(level)
        });

        console.log(levels)

        filteredData = filteredData.filter(d => levels.includes(d.LIVELLO))

        console.log("dati filtrati per livello: ", filteredData)


        let prove = [];

        ["SCRITTO", "PARLATO"].map((prova) => {
            if ($(`#${prova}`).is(":checked"))
                prove.push(prova)
        });

        console.log(prove)

        filteredData = filteredData.filter(d => prove.includes(d.PROVA))

        console.log("dati filtrati per prova: ", filteredData)



        let types = [];

        ["S1", "S2", "P1", "P2"].map((type) => {
            if ($(`#${type}`).is(":checked"))
                types.push(type)
        });

        console.log(types)

        filteredData = filteredData.filter(d => types.includes(d.DOMANDA))

        console.log("dati filtrati per tipo di domanda: ", filteredData)
        console.log("--------------------------------")

        let inds = [];

        // ["LESSICO", "CORRETTEZZA", "ADEMPIMENTO-2017", "COERENZA", "CAPACITA", "OPINIONI", "SENTIMENTI", "IMPRESSIONE", "ORTOGRAFIA"].map((ind) => {
        //     let indicatore = ind.split("-")[0]
        //     console.log(indicatore)

        //     // console.log( $('select[name=INDICATORE2]').val())
        //     // if ($(`#${ind}`).is(":selected")) {
        //     //     //indicatore = ind.split("-")[0]
        //     //     inds.push(indicatore)
        //     // }
        //     //inds.push($('select[name=INDICATORE2]').val())
        // });
        console.log($('select[name=INDICATORE2]').val())
        inds.push($('select[name=INDICATORE2]').val())
        console.log(inds)

        filteredData = filteredData.filter(d => inds.includes(d.INDICATORE))

        console.log("dati filtrati per indicatore: ", filteredData)



        if (filteredData.length == 0)
            alert("Nessun dato corrispondente ai filtri inseriti")


        filteredData.map(row => {
            console.log("row", row)
            let ctx = document.createElement("canvas")
            let title = document.createElement("h1")
            title.className = "titoletto"
            title.textContent = `${row.ANNO} - ${row.LEN} - ${row.LIVELLO} - ${row.DOMANDA} - ${row.INDICATORE}`;
            let container = document.createElement("div")

            container.appendChild(title)
            container.appendChild(ctx)
            container.className = "grafico"

            divGrafici.appendChild(container)

            createGraph(ctx, row.LABEL, row.DATA);
        })

        console.log("--------------------------------")

    }


    function confronta() {
        let divGrafici = document.getElementById("graphs");
        divGrafici.innerHTML = '';

        let lingue = [];

        ["DE", "ENG"].map((lingua) => {
            if ($(`#${lingua}`).is(":checked"))
                lingue.push(lingua)
        });
        filteredData = dati.filter(d => d.LEN == lingue)



        //console.log("dati filtrati per anno: ", filteredData)

        let levels = [];

        ["A1", "A2", "B1"].map((level) => {
            if ($(`#${level}`).is(":checked"))
                levels.push(level)
        });

        //console.log(levels)

        filteredData = filteredData.filter(d => levels.includes(d.LIVELLO))

        //console.log("dati filtrati per livello: ", filteredData)

        let prove = [];

        ["SCRITTO", "PARLATO"].map((prova) => {
            if ($(`#${prova}`).is(":checked"))
                prove.push(prova)
        });

        console.log(prove)

        filteredData = filteredData.filter(d => prove.includes(d.PROVA))

        console.log("dati filtrati per prova: ", filteredData)

        let types = [];

        ["S1", "S2", "P1", "P2"].map((type) => {
            if ($(`#${type}`).is(":checked"))
                types.push(type)
        });

        //console.log(types)

        filteredData = filteredData.filter(d => types.includes(d.DOMANDA))

        //console.log("dati filtrati per tipo di domanda: ", filteredData)
        //console.log("--------------------------------")

        let inds = [];

        // ["LESSICO", "CORRETTEZZA", "ADEMPIMENTO", "COERENZA", "CAPACITA", "OPINIONI", "SENTIMENTI"].map((ind) => {
        //     if ($(`#${ind}`).is(":checked"))
        //         inds.push(ind)
        // });

        // console.log(inds)
        if (document.getElementById("SCRITTO").checked) {
            inds.push($('select[name=INDICATORE2]').val())
        }

        if (document.getElementById("PARLATO").checked) {
            inds.push($('select[name=INDICATORE3]').val())
        }


        filteredData = filteredData.filter(d => inds.includes(d.INDICATORE))

        console.log("dati filtrati per indicatore: ")
        filteredData.map(data => console.log(data))


        let comparati = [];
        while (filteredData.length > 0) {
            let first = filteredData.shift()
            console.log(">-----------")
            console.log("first", first)

            let i = 0;
            while (i < filteredData.length &&
                (
                    filteredData[i].DOMANDA != first.DOMANDA ||
                    filteredData[i].LIVELLO != first.LIVELLO ||
                    filteredData[i].PROVA != first.PROVA ||
                    filteredData[i].INDICATORE != first.INDICATORE
                )
            ) {
                i++
            }

            let second = filteredData[i];
            filteredData.splice(i, 1);
            console.log("trovato altro dato: ", second)


            if (second) {

                comparati.push({
                    LABEL: first.LABEL,
                    data1: first.DATA,
                    data2: second.DATA,
                    LEN: first.LEN,
                    LIVELLO: first.LIVELLO,
                    DOMANDA: first.DOMANDA,
                    INDICATORE: first.INDICATORE
                })

            }
        }

        if (comparati.length == 0)
            alert("Nessun dato corrispondente ai filtri inseriti")

        comparati.map(row => {
            let ctx = document.createElement("canvas")
            let title = document.createElement("h1")
            title.className = "titoletto"
            title.textContent = `${row.LEN} - ${row.LIVELLO} - ${row.DOMANDA} - ${row.INDICATORE}`;
            let container = document.createElement("div")

            container.appendChild(title)
            container.appendChild(ctx)
            container.className = "grafico"

            divGrafici.appendChild(container)

            createGraph2(ctx, row.LABEL, row.data1, row.data2);
        })

        console.log("--------------------------------")


    }




    function createGraph(ctx, labels, data) {

        let campo = "frequency"

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '# of Votes',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 0, 0, 0.8)',
                        'rgba(255, 128, 0, 0.8)',
                        'rgba(0, 179, 60, 0.8)'

                    ],
                    borderColor: [
                        'rgba(255, 0, 0, 1)',
                        'rgba(255, 128, 0, 1)',
                        'rgba(0, 179, 60, 0.8)'

                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },

                legend: {
                    display: false
                },
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem) {
                            return tooltipItem.yLabel;
                        }
                    }
                }
            }

        });

        // myChart.canvas.parentNode.style.height = '500px';
        // myChart.canvas.parentNode.style.width = '500px';
        return ctx;
    }


    function createGraph2(ctx, labels, data1, data2) {



        var myChart2 = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["0", "1", "2"],
                datasets: [
                    {
                        label: "2016",
                        backgroundColor: "#66a3ff",
                        data: data1
                    }, {
                        label: "2017",
                        backgroundColor: "#ff9933",
                        data: data2
                    }
                ]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },

                legend: {
                    display: true
                },
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem) {
                            return tooltipItem.yLabel;
                        }
                    }
                }
            }


        });

    }


    function modificaDomanda() {
        set("S1", !document.getElementById("A1").checked)
        if (document.getElementById("A1").checked)
            $("#S1color").css("color", "rgba(0,0,0,0.2)")
        else
            $("#S1color").css("color", "rgba(0,0,0,1)")
    }

    function modificaIndicatore() {
        set("COERENZA", !document.getElementById("S2").checked)
        set("CAPACITA", !document.getElementById("S2").checked)
        set("OPINIONI", !document.getElementById("S2").checked)
        set("SENTIMENTI", !document.getElementById("S2").checked)

    }

    function set(id, abilitato) {
        let element = document.getElementById(id)
        if (abilitato) {
            element.disabled = false;
        }
        else {
            element.disabled = true;
            element.checked = false;
        }
    }

    function visualizza2016() {
        if (document.getElementById("2016").checked) {
            $("#INDICATORE2 option[value=IMPRESSIONE").attr('disabled', "disabled");
            $("#INDICATORE2 option[value=ORTOGRAFIA").attr('disabled', "disabled");
        }
        else {
            $("#INDICATORE2 option[value=IMPRESSIONE").removeAttr('disabled', "enab");
            $("#INDICATORE2 option[value=ORTOGRAFIA").removeAttr('disabled', "disabled");
        }
    }

    function visualizza2017() {
        if (document.getElementById("2017").checked) {
            $("#INDICATORE2 option[value=SENTIMENTI").attr('disabled', "disabled");
            $("#INDICATORE2 option[value=OPINIONI").attr('disabled', "disabled");
            $("#INDICATORE2 option[value=COERENZA").attr('disabled', "disabled");
        }
        else {
            $("#INDICATORE2 option[value=SENTIMENTI").removeAttr('disabled');
            $("#INDICATORE2 option[value=OPINIONI").removeAttr('disabled');
            $("#INDICATORE2 option[value=COERENZA").removeAttr('disabled');
        }
    }


    function IndicatoriScr() {
        if (document.getElementById("SCRITTO").checked) {
            $("#indicatoriScr").toggle();
            $("#scrittobox").toggle();


        }
        if ($("#indicatoriPar").is(":visible")) {
            $("#indicatoriPar").toggle();
            $("#parlatobox").toggle();
            document.getElementById("S1").checked = false;
            document.getElementById("S2").checked = false;
        }

    }

    function IndicatoriPar() {
        if (document.getElementById("PARLATO").checked) {
            $("#indicatoriPar").toggle();
            $("#parlatobox").toggle();


        }
        if ($("#indicatoriScr").is(":visible")) {
            $("#indicatoriScr").toggle();
            $("#scrittobox").toggle();
            document.getElementById("P1").checked = false;
            document.getElementById("P2").checked = false;
        }
    }


</script>

</html>